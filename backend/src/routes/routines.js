import express from 'express';import multer from 'multer';import path from 'path';import Routine from '../models/Routine.js';import auth from '../middleware/auth.js';const upload=multer({dest:path.join(process.cwd(),'src','uploads')});const r=express.Router();r.use(auth);async function ensure(userId){let rt=await Routine.findOne({userId});if(!rt)rt=await Routine.create({userId,planner:{},notifyTimes:{},manual:{},picturePath:''});return rt}r.get('/',async(req,res)=>{const rt=await ensure(req.user.id);res.json({planner:Object.fromEntries(rt.planner||[]),notifyTimes:Object.fromEntries(rt.notifyTimes||[]),manual:Object.fromEntries(rt.manual||[]),picturePath:rt.picturePath||''})});r.patch('/',async(req,res)=>{const {planner,notifyTimes,manual}=req.body;const rt=await ensure(req.user.id);if(planner)rt.planner=planner;if(notifyTimes)rt.notifyTimes=notifyTimes;if(manual)rt.manual=manual;await rt.save();res.json({ok:true})});r.post('/picture',upload.single('file'),async(req,res)=>{const rt=await ensure(req.user.id);rt.picturePath=req.file?`/uploads/${req.file.filename}`:'';await rt.save();res.json({ok:true,picturePath:rt.picturePath})});export default r
